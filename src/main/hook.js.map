{"version":3,"file":"hook.js","sourceRoot":"","sources":["hook.ts"],"names":[],"mappings":"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","sourcesContent":["import { ipcMain } from 'electron';\r\nimport GameReader from './GameReader';\r\n// import iohook from 'iohook';\r\nimport { keyboardWatcher } from 'node-keyboard-watcher';\r\nimport Store from 'electron-store';\r\nimport { ISettings } from '../common/ISettings';\r\nimport { IpcHandlerMessages, IpcRendererMessages, IpcSyncMessages } from '../common/ipc-messages';\r\n// import { GenerateAvatars } from './avatarGenerator';\r\n\r\nconst store = new Store<ISettings>();\r\n\r\nconst currentPlayerConfigMap = store.get('playerConfigMap', {});\r\nconst playerConfigMapLength = Object.keys(currentPlayerConfigMap).length;\r\nconsole.log('CONFIG count: ', playerConfigMapLength);\r\nif (playerConfigMapLength > 50) {\r\n\tstore.set('playerConfigMap', {});\r\n}\r\n\r\nlet readingGame = false;\r\nexport let gameReader: GameReader;\r\n\r\nlet pushToTalkShortcut: K | undefined;\r\nlet deafenShortcut: K | undefined;\r\nlet muteShortcut: K | undefined;\r\nlet impostorRadioShortcut: K | undefined;\r\nfunction resetKeyHooks(): void {\r\n\tpushToTalkShortcut = store.get('pushToTalkShortcut', 'V') as K;\r\n\tdeafenShortcut = store.get('deafenShortcut', 'RControl') as K;\r\n\tmuteShortcut = store.get('muteShortcut', 'RAlt') as K;\r\n\timpostorRadioShortcut = store.get('impostorRadioShortcut', 'F') as K;\r\n\tkeyboardWatcher.clearKeyHooks();\r\n\taddKeyHandler(pushToTalkShortcut);\r\n\taddKeyHandler(deafenShortcut);\r\n\taddKeyHandler(muteShortcut);\r\n\taddKeyHandler(impostorRadioShortcut);\r\n}\r\n\r\nipcMain.on(IpcHandlerMessages.RESET_KEYHOOKS, () => {\r\n\tresetKeyHooks();\r\n});\r\n\r\nipcMain.on(IpcHandlerMessages.JOIN_LOBBY, (event, lobbycode, server) => {\r\n\tconst tryjoin = gameReader?.joinGame(lobbycode, server);\r\n\tconsole.log('JOIN LOBBY:', lobbycode, tryjoin);\r\n\r\n\tif (!tryjoin) {\r\n\t\tevent.reply(IpcHandlerMessages.JOIN_LOBBY_ERROR, lobbycode, server);\r\n\t}\r\n});\r\n\r\nipcMain.on(IpcSyncMessages.GET_INITIAL_STATE, (event) => {\r\n\tif (!readingGame) {\r\n\t\tconsole.error('Recieved GET_INITIAL_STATE message before the START_HOOK message was received');\r\n\t\tevent.returnValue = null;\r\n\t\treturn;\r\n\t}\r\n\tevent.returnValue = gameReader.lastState;\r\n});\r\n\r\nipcMain.handle(IpcHandlerMessages.START_HOOK, async (event) => {\r\n\tif (!readingGame) {\r\n\t\treadingGame = true;\r\n\t\tresetKeyHooks();\r\n\r\n\t\tkeyboardWatcher.on('keydown', (keyId: number) => {\r\n\t\t\tif (keyCodeMatches(pushToTalkShortcut!, keyId)) {\r\n\t\t\t\tevent.sender.send(IpcRendererMessages.PUSH_TO_TALK, true);\r\n\t\t\t}\r\n\t\t\tif (keyCodeMatches(impostorRadioShortcut!, keyId)) {\r\n\t\t\t\tevent.sender.send(IpcRendererMessages.IMPOSTOR_RADIO, true);\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t\tkeyboardWatcher.on('keyup', (keyId: number) => {\r\n\t\t\tif (keyCodeMatches(pushToTalkShortcut!, keyId)) {\r\n\t\t\t\tevent.sender.send(IpcRendererMessages.PUSH_TO_TALK, false);\r\n\t\t\t}\r\n\t\t\tif (keyCodeMatches(deafenShortcut!, keyId)) {\r\n\t\t\t\tevent.sender.send(IpcRendererMessages.TOGGLE_DEAFEN);\r\n\t\t\t}\r\n\t\t\tif (keyCodeMatches(muteShortcut!, keyId)) {\r\n\t\t\t\tevent.sender.send(IpcRendererMessages.TOGGLE_MUTE);\r\n\t\t\t}\r\n\t\t\tif (keyCodeMatches(impostorRadioShortcut!, keyId)) {\r\n\t\t\t\tevent.sender.send(IpcRendererMessages.IMPOSTOR_RADIO, false);\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t\tkeyboardWatcher.start();\r\n\r\n\t\t// Read game memory\r\n\t\tgameReader = new GameReader(event.sender.send.bind(event.sender));\r\n\t\tlet gotError = false;\r\n\t\tconst frame = async () => {\r\n\t\t\tconst err = await gameReader.loop();\r\n\t\t\tif (err) {\r\n\t\t\t\t// readingGame = false;\r\n\t\t\t\tgotError = true;\r\n\t\t\t\tevent.sender.send(IpcRendererMessages.ERROR, err);\r\n\t\t\t\tsetTimeout(frame, 7500);\r\n\t\t\t} else {\r\n\t\t\t\tif (gotError) {\r\n\t\t\t\t\tevent.sender.send(IpcRendererMessages.ERROR, '');\r\n\t\t\t\t\tgotError = false;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tsetTimeout(frame, 1000 / 5);\r\n\t\t\t}\r\n\t\t};\r\n\t\tawait frame();\r\n\t} else if (gameReader) {\r\n\t\tgameReader.amongUs = null;\r\n\t\tgameReader.checkProcessDelay = 0;\r\n\t}\r\n});\r\n\r\nipcMain.on('reload', async (lobbybrowser) => {\r\n\tif (!lobbybrowser) {\r\n\t\tglobal.mainWindow?.reload();\r\n\t}\r\n\tglobal.lobbyBrowser?.reload();\r\n\t//\tglobal.overlay?.reload();\r\n});\r\n\r\nipcMain.on('minimize', async (lobbybrowser) => {\r\n\tif (!lobbybrowser) {\r\n\t\tglobal.mainWindow?.minimize();\r\n\t}\r\n\tglobal.lobbyBrowser?.minimize();\r\n\t//\tglobal.overlay?.reload();\r\n});\r\n\r\n// GenerateAvatars().then(() => console.log(\"done generate\")).catch((e) => console.error(e));\r\n\r\nconst keycodeMap = {\r\n\tSpace: 0x20,\r\n\tBackspace: 0x08,\r\n\tDelete: 0x2e,\r\n\tEnter: 0x0d,\r\n\tUp: 0x26,\r\n\tDown: 0x28,\r\n\tLeft: 0x24,\r\n\tRight: 0x27,\r\n\tHome: 0x24,\r\n\tEnd: 0x23,\r\n\tPageUp: 0x21,\r\n\tPageDown: 0x22,\r\n\tEscape: 0x1b,\r\n\tControl: 0x11,\r\n\tLShift: 0xa0,\r\n\tRShift: 0xa1,\r\n\tRAlt: 0xa5,\r\n\tLAlt: 0xa4,\r\n\tRControl: 0xa3,\r\n\tLControl: 0xa2,\r\n\tShift: 0x10,\r\n\tAlt: 0x12,\r\n\tF1: 0x70,\r\n\tF2: 0x71,\r\n\tF3: 0x72,\r\n\tF4: 0x73,\r\n\tF5: 0x74,\r\n\tF6: 0x75,\r\n\tF7: 0x76,\r\n\tF8: 0x77,\r\n\tF9: 0x78,\r\n\tF10: 0x79,\r\n\tF11: 0x7a,\r\n\tF12: 0x7b,\r\n\tMouseButton4: 0x05,\r\n\tMouseButton5: 0x06,\r\n\tNumpad0: 0x60,\r\n\tNumpad1: 0x61,\r\n\tNumpad2: 0x62,\r\n\tNumpad3: 0x63,\r\n\tNumpad4: 0x64,\r\n\tNumpad5: 0x65,\r\n\tNumpad6: 0x66,\r\n\tNumpad7: 0x67,\r\n\tNumpad8: 0x68,\r\n\tNumpad9: 0x69,\r\n\tDisabled: -1,\r\n};\r\ntype K = keyof typeof keycodeMap;\r\n\r\nfunction keyCodeMatches(key: K, keyId: number): boolean {\r\n\tif (keycodeMap[key]) return keycodeMap[key] === keyId;\r\n\telse if (key && key.length === 1) return key.charCodeAt(0) === keyId;\r\n\telse {\r\n\t\tconsole.error('Invalid key', key);\r\n\t\treturn false;\r\n\t}\r\n}\r\n\r\nfunction addKeyHandler(key: K) {\r\n\tif (keycodeMap[key] && keycodeMap[key] !== -1) {\r\n\t\tkeyboardWatcher.addKeyHook(keycodeMap[key]);\r\n\t} else if (key && key.length === 1) {\r\n\t\tkeyboardWatcher.addKeyHook(key.charCodeAt(0));\r\n\t}\r\n}\r\n"]}